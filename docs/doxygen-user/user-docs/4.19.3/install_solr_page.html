<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Autopsy User Documentation: Install and Configure Solr</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Autopsy User Documentation<span id="projectnumber">&#160;4.19.3</span>
   </div>
   <div id="projectbrief">Graphical digital forensics platform for The Sleuth Kit and other tools.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Install and Configure Solr </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#install_solr_overview">Overview</a></li>
<li class="level1"><a href="#install_solr_prereq">Prerequisites</a></li>
<li class="level1"><a href="#install_solr_install">Solr Installation</a><ul><li class="level2"><a href="#install_solr_jre">JRE Installation</a></li>
<li class="level2"><a href="#install_solr_config">Solr Configuration</a><ul><li class="level3"><a href="#install_solr_params">Solr Configuration Parameters</a></li>
<li class="level3"><a href="#install_sorl_index_file_loc">Solr Text Index File Location</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#install_solr_service">Solr Windows Service Installation</a><ul><li class="level2"><a href="#install_solr_service_user">Configure Service User</a></li>
<li class="level2"><a href="#install_solr_start">Start Solr Service</a></li>
<li class="level2"><a href="#install_solr_security">AntiVirus Settings</a></li>
</ul>
</li>
<li class="level1"><a href="#install_solr_testing">Testing</a></li>
<li class="level1"><a href="#install_solr_autopsy">Configuring Autopsy Clients</a></li>
<li class="level1"><a href="#install_sorl_adding_nodes">Adding More Solr Nodes (SolrCloud)</a></li>
<li class="level1"><a href="#install_solr_autopsy_zk">Autopsy’s Use of ZooKeeper Service</a><ul><li class="level2"><a href="#install_solr_standalone_zk">Standalone ZooKeeper Server</a></li>
</ul>
</li>
<li class="level1"><a href="#install_solr_backup">Backing Up</a></li>
<li class="level1"><a href="#troubleshooting">Troubleshooting / Performance Tuning</a><ul><li class="level2"><a href="#install_solr_delayed_start">Delayed Start Problems With Large Number Of Solr Collections</a></li>
<li class="level2"><a href="#install_solr_heap_usage">Solr Heap Usage and Recommendations</a><ul><li class="level3"><a href="#install_solr_heap_troublshooting">Troubleshooting Solr Heap Issues</a></li>
<li class="level3"><a href="#install_solr_monitoring">Monitoring Solr Heap Usage</a></li>
<li class="level3"><a href="#install_solr_performance_tuning">Notes on Solr Performance Tuning</a></li>
</ul>
</li>
<li class="level2"><a href="#solr_commit_tuning">Tuning Solr Server Commit Operations</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="install_solr_overview"></a>
Overview</h1>
<p>Autopsy uses Apache Solr to store keyword text indexes. A central server is needed in a multi-user cluster to maintain and search the indexes.</p>
<p>A new text index is created for each case. The index can be stored either on shared storage or on the local drive of the Solr server(s) (large amount of local storage is required).</p>
<p>Solr's embedded ZooKeeper is also used as a coordination service for Autopsy.</p>
<p>If you have already installed Solr 4 with a previous version of Autopsy, please see the <a class="el" href="upgrade_solr8_page.html">Upgrading to Autopsy 4.18.0 (with Solr 8)</a> page for information on how open older cases after the upgrade and migrate data.</p>
<p>NOTE: This document assumes you will be running Solr on Windows as a service. You can run it as a non-service or on another platform, but you'll need to understand the steps in this document to make that happen.</p>
<h1><a class="anchor" id="install_solr_prereq"></a>
Prerequisites</h1>
<p>You will need: </p><ul>
<li>
A 64-bit version of the Java 8 Runtime Environment (JRE) from <a href="https://github.com/ojdkbuild/ojdkbuild">https://github.com/ojdkbuild/ojdkbuild</a>. (<a href="https://github.com/ojdkbuild/ojdkbuild/blob/master/README.md">Download links</a>) </li>
<li>
Pre-packaged Autopsy version of Solr from <a href="https://sourceforge.net/projects/autopsy/files/CollaborativeServices/Solr/SOLR_8.6.3_AutopsyService.zip/download">here</a>. This contains Solr, <a href="https://nssm.cc/">NSSM</a> to make it run as a service, and the needed schema config files. </li>
<li>
A network-accessible machine to install Solr on. Note that the Solr process may need to write to a shared storage drive (if that is how you configure it) and will therefore need adequate permissions. </li>
</ul>
<h1><a class="anchor" id="install_solr_install"></a>
Solr Installation</h1>
<h2><a class="anchor" id="install_solr_jre"></a>
JRE Installation</h2>
<p>Solr requires a Java Runtime Environment (JRE), which may already be installed. You can test this by running <code>"where java"</code> from the command line. If you see output similar to the results below, you have a JRE.</p>
<div class="image">
<img src="wherejava.PNG" alt=""/>
</div>
<p>If you need the JRE, use the link in the <a class="el" href="install_solr_page.html#install_solr_prereq">Prerequisites</a> section above to download an installer. Accept the default settings during installation.</p>
<h2><a class="anchor" id="install_solr_config"></a>
Solr Configuration</h2>
<p>Follow these steps to configure Solr:</p>
<ol>
<li>
Extract the solr-8.6.3.zip archive from the location given in the <a class="el" href="install_solr_page.html#install_solr_prereq">Prerequisites</a> section into a directory of your choice. The rest of this document assumes that the archive is extracted into <code>"C:\solr-8.6.3"</code> directory. </li>
<li>
Go to the <code>"C:\solr-8.6.3\bin"</code> directory and open the <code>"solr.in.cmd"</code> file in a text editor. <div class="image">
<img src="solr_config_folder.png" alt=""/>
</div>
 </li>
<li>
<p class="startli">Search for each "TODO" and specify a valid path for each of the required configuration parameters. These parameters will be described in detail <a class="el" href="install_solr_page.html#install_solr_params">below</a>.</p>
<div class="image">
<img src="solr_config_todo.png" alt=""/>
</div>
<p> <br  />
 </p><div class="image">
<img src="solr_config_param.png" alt=""/>
</div>
 </li>
</ol>
<h3><a class="anchor" id="install_solr_params"></a>
Solr Configuration Parameters</h3>
<p>Required Solr Configuration Parameters: </p><ul>
<li>
<b>JAVA_HOME</b> – path to 64-bit JRE installation. For example <code>"JAVA_HOME=C:\Program Files\Java\jre1.8.0_151"</code> or <code>"JAVA_HOME=C:\Program Files\ojdkbuild\java-1.8.0-openjdk-1.8.0.222-1"</code> </li>
<li>
<b>DEFAULT_CONFDIR</b> – path to Autopsy configuration directory. If the Solr archive was extracted into <code>"C:\solr-8.6.3"</code> directory, then this path will be <code>"C:\ solr-8.6.3\server\solr\configsets\AutopsyConfig\conf"</code>. Do not include quotes around the path. </li>
<li>
<b>SOLR_JAVA_MEM</b> - Solr JVM heap size should be as large as the Solr machine’s resources allow, at least half of the total RAM available on the machine. A rule of thumb would be use "set SOLR_JAVA_MEM=-Xms2G -Xmx40G" for a machine with 64GB of RAM, "set SOLR_JAVA_MEM=-Xms2G -Xmx20G" for a machine with 32GB of RAM, and "set SOLR_JAVA_MEM=-Xms2G -Xmx8G" for a machine with 16GB of RAM. Please see the <a class="el" href="install_solr_page.html#install_solr_heap_usage">troubleshooting section</a> for more info regarding Solr heap usage and troubleshooting information. </li>
<li>
<b>SOLR_DATA_HOME</b> – location where Solr indexes will be stored. If this is not configured, the indexes will be stored in the <code>"C:\solr-8.6.3\server\solr"</code> directory. NOTE: for Autopsy cases consisting of large number of data sources, Solr indexes can get very large (hundreds of GBs, or TBs) so they should probably be stored on a larger network share. </li>
</ul>
<p>Optional Solr Configuration Parameters: </p><ul>
<li>
<b>SOLR_HOST</b> – by default, the Solr node name is "localhost". If multiple Solr nodes are going to be used as part of Solr Cloud, then specify the current computer’s host name in the SOLR_HOST variable. </li>
</ul>
<h3><a class="anchor" id="install_sorl_index_file_loc"></a>
Solr Text Index File Location</h3>
<p><b>Important note:</b> previous versions of Autopsy (Autopsy 4.17.0 and earlier) stored the Solr text indexes in the case output directory. As a result, the Solr indexes would get deleted if a user deleted the case output directory. Solr 8 (i.e. Autopsy 4.18.0 and later) no longer stores the Solr text index files in the case output directory but instead stores them in location defined by the <b>SOLR_DATA_HOME</b> parameter. As a consequence, if a user choses to manually delete case output directories (for example, to free up disk space), the Solr index directories located in <b>SOLR_DATA_HOME</b> need to be manually deleted as well.</p>
<p>Text index for an Autopsy case will follow a naming structure according to following rules: <code>"[Autopsy case name] [Case creation time stamp] [Text index creation time stamp] [shardX_replica_nY]"</code>. For example, the text index for an Autopsy case "Test Case" will be located in the following directory inside <b>SOLR_DATA_HOME</b>:</p>
<div class="image">
<img src="solr_config_case.png" alt=""/>
</div>
<h1><a class="anchor" id="install_solr_service"></a>
Solr Windows Service Installation</h1>
<p>At this point Solr has been configured and ready to use. The last step is to configure it as a Windows service so that it starts each time the computer starts.</p>
<p>Open a command line console as Administrator and navigate to the <code>"C:\solr-8.6.3\bin"</code> directory. From there, run the following command: <code>"nssm install Solr_8.6.3"</code>.</p>
<div class="image">
<img src="solr_install_1.png" alt=""/>
</div>
<p>An NSSM UI window will appear. Click the "Path" navigation button:</p>
<div class="image">
<img src="solr_install_2.png" alt=""/>
</div>
<p>Select the <code>"C:\solr-8.6.3\bin\solr.cmd"</code> file. NOTE: Make sure you don’t select the <code>"solr.in.cmd"</code> file by accident. In the "Arguments" parameter, type in <code>"start –f –c"</code>:</p>
<div class="image">
<img src="solr_install_3.png" alt=""/>
</div>
<p>Optionally, configure service’s display name, startup type, and account info:</p>
<div class="image">
<img src="solr_install_4.png" alt=""/>
</div>
<h2><a class="anchor" id="install_solr_service_user"></a>
Configure Service User</h2>
<p>In the <a class="el" href="install_multiuseruser_page.html">Pick Your User Accounts</a> section, you should have decided what user to run Solr as. To configure Solr to run as that user, you'll use Windows Service Manager.</p>
<p>Switch to the "Log On" tab to change the logon credentials to the chosen user who will have access to the shared storage. </p><ul>
<li>
If you specify a domain account, the account name will be in the form of <code>"DOMAINNAME\username"</code> as shown in the example below</li>
</ul>
<div class="image">
<img src="solr_user_1.png" alt=""/>
</div>
<p>Click <code>"Install Service"</code>. You should see the following UI window appear:</p>
<div class="image">
<img src="solr_user_2.png" alt=""/>
</div>
<h2><a class="anchor" id="install_solr_start"></a>
Start Solr Service</h2>
<p>At this point the Solr service has been configured and installed. You can verify this by opening Windows "Services" window:</p>
<div class="image">
<img src="solr_start_1.png" alt=""/>
</div>
<p>Start the "Solr_8.6.3" service, and verify that the service status changes to "Running".</p>
<div class="image">
<img src="solr_start_2.png" alt=""/>
</div>
<h2><a class="anchor" id="install_solr_security"></a>
AntiVirus Settings</h2>
<p>We have observed that Antivirus may detect strings in the Solr indexes as being malware. You should add the Solr data directory to the exclusion list for your security product. We saw this with Windows Defender.</p>
<h1><a class="anchor" id="install_solr_testing"></a>
Testing</h1>
<p>There are two tests that you should perform to confirm that the Solr machine is configured correctly.</p>
<ul>
<li>
<p class="startli"><b>Web Interface:</b> You should attempt to access the Solr admin panel in a web browser. On the Solr machine, navigate to <a href="http://localhost:8983/solr/#/">http://localhost:8983/solr/#/</a> and verify that the Solr admin console gets displayed. You should also attempt to access the Solr admin panel in a web browser from another machine on the network. Replace "localhost" in the previous URL with the IP address or the host name that the Solr service is running on.</p>
<div class="image">
<img src="solr_testing_1.png" alt=""/>
</div>
<p class="interli">If the service is appropriately started but you are unable to see the screenshot above, then it could be that port 8983 for Solr and port 9983 for ZooKeeper are blocked by your firewall. Contact your network administrator to open these ports.</p>
<p class="endli"></p>
</li>
<li>
<b>Shared Storage:</b> Log in to the Solr computer as the user you decided to run the Solr service as and attempt to access the shared storage paths. Ensure that you can access the UNC paths (or drive letters if you have hardware NAS). If everything is configured correctly you should be able to access the storage paths without having to provide credentials. If you are prompted for a password to access the shared storage, then either enter the password and choose to save the credentials or reconfigure the setup so that the same passwords are used. See the <a class="el" href="install_multiuseruser_page.html#multiuser_users_store">Storing Credentials</a> section for steps on storing credentials. If you needed to store the credentials, then you should restart the service or reboot the computer (we have observed that a running service does not get the updated credentials). </li>
</ul>
<h1><a class="anchor" id="install_solr_autopsy"></a>
Configuring Autopsy Clients</h1>
<p>Once the rest of the services are configured you will <a class="el" href="install_multiuserclient_page.html">configure Autopsy to enable multi-user cases</a>. For the Solr 8 server, configure the Solr 8 Service and the ZooKeeper service connection info. ZooKeeper connection info is required. The ZooKeeper port number is 1000 higher than Solr service port number. By default, Solr service port is 8983 making the embedded ZooKeeper port 9983. You may also use a <a class="el" href="install_solr_page.html#install_solr_standalone_zk">standalone ZooKeeper service</a>.</p>
<h1><a class="anchor" id="install_sorl_adding_nodes"></a>
Adding More Solr Nodes (SolrCloud)</h1>
<p>Solr 8 has ability for multiple Solr nodes to work together as a Solr cluster. In this mode (SolrCloud mode) each Solr collection/index is split across all of the available Solr nodes. This is called sharding. For example, if there are 4 Solr nodes in a SolrCloud cluster, then the text index will be split across the 4 Solr nodes, thus greatly reducing the load on each individual Solr server and improving Solr indexing and searching performance.</p>
<p>To create a Solr cluster, the following steps need to be taken: </p><ol>
<li>
Follow steps in the <a class="el" href="install_solr_page.html#install_solr_config">Solr Configuration</a> and <a class="el" href="install_solr_page.html#install_solr_service">Solr Windows Service Installation</a> sections to create a Solr node (e.g. "Solr1"). Start the Solr service on the Solr1 machine. This machine will host the ZooKeeper service for the SolrCloud cluster. </li>
<li>
To add an additional Solr node (e.g. "Solr2") to the SolrCloud cluster, follow the steps in the <a class="el" href="install_solr_page.html#install_solr_config">Solr Configuration</a> and <a class="el" href="install_solr_page.html#install_solr_service">Solr Windows Service Installation</a> sections on the Solr2 machine. Do not start the Solr service on Solr2 yet. </li>
<li>
Solr uses ZooKeeper for its internal coordination, so all of the Solr nodes in SolrCloud need to be pointed at the same ZooKeeper service instance. Therefore in order for Solr2 node to be part of SolrCloud, it needs to use the ZooKeeper service that all the other Solr nodes in the SolrCloud cluster are using. In step 1 we have configured Solr1 node to start its embedded ZooKeeper service (this is default Solr behavior). To achieve that, <b>ZK_HOST</b> setting on Solr2 needs to be changed to point at the ZooKeeper service that is running on Solr1 node. The ZooKeeper port number is 1000 higher than <b>SOLR_PORT</b>. By default, <b>SOLR_PORT</b> is 8983 so the embedded ZooKeeper port is 9983. Therefore the <b>ZK_HOST</b> setting in <code>"C:\solr-8.6.3\bin\solr.in.cmd"</code> file (assuming that the Solr package ZIP was extracted into <code>"C:\solr-8.6.3\" directory) on Solr2 machine needs to be modified to use ZooKeeper service running on Solr1:9983.

@image html solr_adding_nodes_1.png

&lt;li&gt;Start Solr service on Solr2 machine.
&lt;li&gt;When you log into a Solr admin console on either Solr1 or Solr2 (via either going to http://localhost:8983/solr/#/ on the machine, or via http://solr1:8983/solr/#/), and then navigate to "Cloud" -&gt; "Nodes" section of the admin tree, you should see all of the Solr nodes that are part of the SolrCloud:

@image html solr_adding_nodes_2.png

&lt;li&gt;Additional Solr nodes can be added to the SolrCloud by repeating the previous steps.
&lt;/ol&gt;

@section install_solr_autopsy_zk Autopsy’s Use of ZooKeeper Service

Autopsy uses ZooKeeper service for multi-user coordination purposes. Autopsy uses ZooKeeper to obtain locks on case level resources before modifying them. Most importantly, Autopsy stores some of its internal state data in ZooKeeper – which cases have been created, their processing state (pending, processing, or completed), as well as other case and job level state data. This is especially important if you are running Autopsy in Auto Ingest Mode, as auto ingest needs to know which jobs have already been processed. 

In the screen shot below, for coordination purposes Autopsy will be using the ZooKeeper server that is running on the Solr 8 server ("Solr1" machine). 

@image html solr_autopsy_zk.png

@subsection install_solr_standalone_zk Standalone ZooKeeper Server

In our testing, for Autopsy purposes it is not necessary to have a standalone ZooKeeper server. For the regular Autopsy use case it is sufficient to use the "embedded" ZooKeeper service that is started by Solr service (on port 9983). However, Apache Solr documentation recommends that a standalone ZooKeeper service (running on separate a machine) is used in production environments. Below are instructions on how to setup a standalone ZooKeeper server and how to configure Solr &amp; Autopsy to use it. 

General Solr-related steps for this process are outlined in the Solr user guide below, in section "SolrCloud</code> Configuration and Parameters":

https://lucene.apache.org/solr/guide/8_6/solrcloud-configuration-and-parameters.html

&lt;ol&gt;
&lt;li&gt;Download the appropriate Zookeeper installation from http://zookeeper.apache.org/releases.html . Solr 8.6.3 is integrated with Zookeeper 3.5.7. There are several options for download – binaries or source code. The file that you are looking for is \c "apache-zookeeper-3.5.7-bin.tar.gz":
https://archive.apache.org/dist/zookeeper/zookeeper-3.5.7/
&lt;li&gt;Extract the downloaded tar file containing Zookeeper installation
&lt;li&gt;Create/edit the \c "/conf/zoo.cfg" file to have the following: 
&lt;ul&gt;
&lt;li&gt;Specify "dataDir" directory – this is where ZK database will be stored.
&lt;li&gt;Specify "clientPort". For example, "clientPort=9983". 
&lt;li&gt;"Four letter commands" need to be enabled in ZK config file: https://lucene.apache.org/solr/guide/8_6/setting-up-an-external-zookeeper-ensemble.html#configuration-for-a-zookeeper-ensemble
&lt;/ul&gt;
&lt;li&gt;There are Windows and Linux Zookeeeper startup scripts. For Windows, open a command prompt (admin NOT required), go to the directory where the tar file was extracted (e.g. \c "C:\Bitnami\zookeeper-3.5.7"), and type in \c "bin\zkServer.cmd". We have been using Cygwin in our testing and therefore using Linux commands in our examples. For Linux/CygWin, go to the same directory (e.g. \c "C:\Bitnami\zookeeper-3.5.7"), and type in \c "bin/zkServer.sh start".
&lt;li&gt;To verify that Zookeeper is running, in command prompt one can type in \c "bin/zkServer.sh status" (or equivalent Windows command). 

@image html solr_standalone_zk_1.png

&lt;li&gt;To make Solr use the external ZooKeeper, the following needs to be done. Navigate to the directory where Solr startup scripts are located (usually \c "C:\solr-8.6.3\apache-solr\bin"). Open the \c "solr.in.cmd" file in text editor. If standalone ZooKeeper service is running on the same machine (not recommended), edit the &lt;b&gt;ZK_HOST&lt;/b&gt; variable to be \c "set ZK_HOST=localhost:9983". If Zookeeper is running a different machine (e.g. "Solr5"), then enter the Zookeeper machine's host name or IP address instead of "localhost" (e.g. \c "set ZK_HOST=Solr5:9983").

@image html solr_standalone_zk_2.png

&lt;li&gt;Re-installation of Solr service is not necessary. Simply stop the Solr service and re-start it.
&lt;li&gt;Once the Solr service has been restarted, you can navigate to Solr admin console (Cloud -&gt; ZK Status) and verify that Solr is using the correct Zookeeper and that the Zookeeper is running. 

@image html solr_standalone_zk_3.png

&lt;li&gt;Configure Autopsy Multi-User panel to use the standalone ZooKeeper server. Start Autopsy and open the multi-user settings panel from "Tools", "Options", "Multi-user". Note that in order to create or open Multi-user cases, "Enable Multi-user cases" must be checked and the settings below must be correct.

@image html solr_standalone_zk_4.png
&lt;/ol&gt;

@section install_solr_backup Backing Up

Solr creates two types of data that need to be backed up:

&lt;ul&gt;
&lt;li&gt;&lt;b&gt;Text Indexes:&lt;/b&gt; These are stored in directory that was specified in &lt;b&gt;SOLR_DATA_HOME&lt;/b&gt; parameter (see \ref install_solr_params).
&lt;li&gt;&lt;b&gt;ZooKeeper Data:&lt;/b&gt; Autopsy uses a service called ZooKeeper embedded in Solr that stores data about what cases exist and who has them open. This data needs to be backed up so that you can have a list of all available multi-user cases.
&lt;ol&gt;&lt;li&gt;In a default installation that data is stored in \c "C:\solr-8.6.3\server\solr zoo_data" (assuming that the Solr package ZIP was extracted into \c "C:\solr-8.6.3" directory).&lt;/ol&gt;
&lt;/ul&gt;

@section troubleshooting Troubleshooting / Performance Tuning

@subsection install_solr_delayed_start Delayed Start Problems With Large Number Of Solr Collections

In our testing, we have encountered an issue when a very large number (thousands) of Autopsy multi-user cases was created. Each new Autopsy multi-user case creates a Solr "collection" that contains the Solr text index. With 2,000 existing collections, when Solr service is restarted, Solr appears to internally be "loading" roughly 250 collections per minute (in chronological order, starting with oldest collections). After 4 minutes roughly half of the 2,000 collections were loaded. Users are able to search the collections that have been loaded, but they are unable to open or search the collections that have not yet been internally loaded by Solr. After 7-8 minutes all collections were loaded. These numbers will vary depending on the specific cluster configuration, text index file location (network or local storage), network throughput, number of Solr servers, etc. 

@subsection install_solr_heap_usage Solr Heap Usage and Recommendations

Solr JVM heap plays especially important role if you are going to create a large number of Autopsy cases (i.e. Solr collections). Here are some “rule of thumb” Solr heap usage stats that we identified during our internal testing:
&lt;ul&gt;
&lt;li&gt;For very small cases/collections, our tests show that Solr uses an absolute minimum of 7-10 MB of heap per collection. 
&lt;li&gt;For larger cases/collections (50-100GB input E01 size) Solr uses at least 65 MB per collection 
&lt;li&gt;For large cases/collections (1.5TB input E01 size) Solr uses at least 850 MB per collection
&lt;/ul&gt;

@subsubsection install_solr_heap_troublshooting Troubleshooting Solr Heap Issues

Once the Solr JVM uses all of its available heap and is unable to free up any memory via garbage collection, the Solr service will not be able to create new collections or may become completely unresponsive, resulting in Autopsy being unable to create new text indexes. Below is a list of some of the errors that you might see as a result of this in the Solr (not Autopsy) service logs and/or the Solr admin console:

&lt;ul&gt;
&lt;li&gt;org.apache.solr.common.SolrException: Could not register as the leader because creating the ephemeral registration node in ZooKeeper failed
&lt;li&gt;RequestHandlerBase org.apache.solr.common.SolrException: Failed to get config from zookeeper
&lt;li&gt;RecoveryStrategy Error while trying to recover. org.apache.solr.common.SolrException: Cloud state still says we are leader.
&lt;li&gt;RequestHandlerBase org.apache.solr.common.SolrException: Could not load collection from ZK
&lt;li&gt;org.apache.solr.common.SolrException: Error CREATEing SolrCore: Unable to create core. Caused by: There are no more files
&lt;li&gt;org.apache.solr.common.SolrException: java.io.IOException: There are no more files
&lt;li&gt;org.apache.solr.common.SolrException: Cannot unload non-existent core
&lt;li&gt;ZkIndexSchemaReader Error creating ZooKeeper watch for the managed schema
&lt;/ul&gt;

You may also see the following ZooKeeper errors:
&lt;ul&gt;
&lt;li&gt;org.apache.zookeeper.KeeperException$NodeExistsException: KeeperErrorCode = NodeExists
&lt;li&gt;org.apache.zookeeper.KeeperException$BadVersionException: KeeperErrorCode = BadVersion for (collection_name)/state.json
&lt;li&gt;org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /roles.json
&lt;li&gt;org.apache.zookeeper.KeeperException$SessionExpiredException: KeeperErrorCode = Session expired for /configs/AutopsyConfig/managed-schema
&lt;/ul&gt;

The common theme among most of these errors is the breakdown in communication between Solr and ZooKeeper, especially when using an embedded ZooKeeper server. It is important to note that these errors may potentially occur for other reasons and are not unique to Solr heap issues. 

@subsubsection install_solr_monitoring Monitoring Solr Heap Usage

The simplest way to see current Solr heap usage is to check the Solr Admin Console web page. To access the Solr admin console, on the Solr machine navigate to http://localhost:8983/solr/#/ . There you will be able to see the Solr memory usage:

@image html solr_config_monitoring.png

However, the dashboard does not show enough detail to know when Solr is out of heap, so it should only be used to identify that you are NOT having heap issues. Even if the dashboard shows that the Solr heap is fully used, it may or may not be an issue. It is best to use profiling tools like Java VisualVM. In order for VisualVM to connect to Solr, you will need to enable the JMX interface for Solr’s Java process. The details are described here:
&lt;ul&gt;&lt;li&gt;https://solr.apache.org/guide/8_3/using-jmx-with-solr.html#using-jmx-with-solr&lt;/ul&gt;

Solr heap and other performance tuning is described in the following article:
&lt;ul&gt;&lt;li&gt;https://cwiki.apache.org/confluence/display/SOLR/SolrPerformanceProblems&lt;/ul&gt;

@subsubsection install_solr_performance_tuning Notes on Solr Performance Tuning

If you are going to work with large images (TBs) and KWS performance is important, the best approach is to use a network (Multi-User) Solr server. 

Some notes:
&lt;ul&gt;
&lt;li&gt;A single Solr server works well for data sources up to 1TB; after that the performance starts to slow down. The performance doesn't "drop off the cliff," but it keeps slowing down as you add more data to the index. After 3TBs of input data the Solr performance takes a significant decline.

&lt;li&gt;A single Multi-User Solr server may not perform much better than a Single-User Autopsy case. However, in Multi-User mode you can add additional Solr servers and create a Solr cluster. See the \ref install_sorl_adding_nodes section in the above documentation. These additional nodes are where the performance gains come from, especially for large input data sources. Apache Solr documentation calls this "SolrCloud" mode and each Solr server is called a "shard". The more Solr servers/shards you have, the better performance you will have for large data sets. On our test and production clusters, we are using 4-6 Solr servers to handle data sets of up to 10TB, which seems to be the upper limit. After that, you are better off breaking your Autopsy case into multiple cases, thus creating a separate Solr index for each case.

&lt;li&gt;In our testing, a 3-node SolrCloud indexes data roughly twice as fast as single Solr node. A 6-node SolrCloud indexes data almost twice as fast as 3-node SolrCloud. After that we did not see much performance gain. These performance figures are heavily dependent on network throughput, machine resources, disk access speeds, and the type of data that is being indexed.

&lt;li&gt;Exact match searches are much faster than substring or regex searches.

&lt;li&gt;Regex searches tend to use a lot of RAM on the Solr server.

&lt;li&gt;Indexing/searching of unallocated space really slows everything down because it is mostly binary or garbled data.

&lt;li&gt;If you are not going to look at the search results until ingest is over then you should disable the periodic keyword searches. They will start taking longer as your input data grows. This can be done in Tools-&gt;Options-&gt;Keyword Search tab:

@image html solr_disable_periodic_search.png

&lt;li&gt;In Single-User mode, if you are ingesting and indexing data sources that are multiple TBs in size, then both Autopsy memory and especially the Solr JVM memory needs to be increased from their default settings. This can be done in Tools-&gt;Options-&gt;Application tab. We would recommend at least 10GB heap size for Autopsy and at least 6-8GB heap size for Solr. Note that these are "maximum" values that the process will be allowed to use/request. The operating system will not allocate more heap than the process actually needs.

@image html solr_jvm.png

&lt;/ul&gt;

@subsection solr_commit_tuning Tuning Solr Server Commit Operations

When Autopsy is running in a multi-user cluster environment with multiple auto ingest nodes, it may be beneficial to tune the configuration of Solr "commit" operations. 

Solr has two types of "commits" – hard commits and soft commits. These are explained in detail the following link: https://lucidworks.com/post/understanding-transaction-logs-softcommit-and-commit-in-sorlcloud/

In short:
&lt;ul&gt;
&lt;li&gt;Hard commits flush newly indexed documents from RAM to Solr index on disk.
&lt;li&gt;Depending on configuration, hard commits may or may not make the newly indexed documents "visible" to search.
&lt;li&gt;Soft commits do not flush newly indexed documents to disk but they make the newly indexed documents "visible" to search.
&lt;/ul&gt;

By default (when using AutopsyConfig) the Solr servers are performing a "hard" commit every 5 minutes and are also making the newly indexed documents "visible" to search. These operations can be costly when performed on a large index which is located on a shared network drive. In this stuation it can be very beneficial to modify Solr configuration (located in \c "SOLR_INSTALLATION_DIECTORY\server\solr\configsets\AutopsyConfig\conf\solrconfig.xml") with the following changes:
&lt;ol&gt;
&lt;li&gt;Modify "hard commits" to still flush the newly created documents every 5 minutes but not make them "visible". This is accomplished by setting “openSearcher" to "false" in the "autoCommit" section of Solr configuration file. </li>
<li>
Enable "soft commits" to be performed every 30 minutes thus making the newly indexed documents "visible" to search every 30 minutes. This is accomplished by enabling the "autoSoftCommit" section of Solr configuration file. The downside is that it may take up to 30 minutes to be able to search the latest document. Keep in mind that this only affects the scenario where an examiner is searching a case while the ingest is still ongoing. Autopsy automatically performs a commit after the ingest is complete so all the documents are immediately visible at that time. </li>
</ol>
<p>The following image shows the Solr configuration changes discussed above:</p>
<div class="image">
<img src="solr_config_autocommit.jpg" alt=""/>
</div>
<p>Until a hard commit is performed, by default Solr also maintains a transaction log which contains the raw text of every newly indexed document since last hard commit. When the Solr index is located on a network share, this again can be a very costly operation. Transaction logs can be disabled by commenting out the "updateLog" section of Solr configuration file:</p>
<div class="image">
<img src="solr_comment_out_updateLog.jpg" alt=""/>
</div>
<p>Keep in mind that this has an unfortunate side effect of creating CommitTracker errors in Solr logs and Solr admin console. These errors can be ignored if transaction log has been intentionally disabled.</p>
<div class="image">
<img src="solr_transaction_log_errors.jpg" alt=""/>
</div>
 </div></div><!-- contents -->
</div><!-- PageDoc -->
<hr/>
<p><i>Copyright &#169; 2012-2022 Basis Technology. Generated on Fri Feb 24 2023<br/> 
This work is licensed under a
<a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-Share Alike 3.0 United States License</a>.
</i></p>
</body>
</html>
